#!/bin/bash
NAME=gcc
VERSION=15.2.0
URL="https://ftp.gnu.org/gnu/gcc/gcc-$VERSION/gcc-$VERSION.tar.xz"

unpack() {
    tar xf "$NAME-$VERSION.tar.xz"

    cd "$NAME-$VERSION"

    # Set default directory name for 64bit libraries to lib.
    case $(uname -m) in
        x86_64)
            sed -e '/m64=/s/lib64/lib/' \
                -i.orig gcc/config/i386/t-linux64
        ;;
    esac

    # Override build rules to allows POSIX threads support.
    sed '/thread_header =/s/@.*@/gthr-posix.h/' \
        -i libgcc/Makefile.in libstdc++-v3/include/Makefile.in
}

pkg_build() {
    cd "$NAME-$VERSION"

    tar -xf ../mpfr-4.2.2.tar.xz
    mv -v mpfr-4.2.2 mpfr
    tar -xf ../gmp-6.3.0.tar.xz
    mv -v gmp-6.3.0 gmp
    tar -xf ../mpc-1.3.1.tar.gz
    mv -v mpc-1.3.1 mpc

    # Clean the old pass 1 build
    rm -rfv build
    mkdir -pv build && cd build
    ../configure \
        --build=$(../config.guess) \
        --host=$LFS_TGT \
        --target=$LFS_TGT \
        --prefix=/usr \
        --with-build-sysroot=$LFS \
        --enable-default-pie \
        --enable-default-ssp \
        --disable-nls \
        --disable-multilib \
        --disable-libatomic \
        --disable-libgomp \
        --disable-libquadmath \
        --disable-libsanitizer \
        --disable-libssp \
        --disable-libvtv \
        --enable-languages=c,c++ \
        LDFLAGS_FOR_TARGET=-L$PWD/$LFS_TGT/libgcc

    make
}

pkg_install() {
    cd "$NAME-$VERSION"/build/
    make DESTDIR=$LFS install

    ln -sv gcc $LFS/usr/bin/cc
}

